# KIRA Activity - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client (Browser)                      â”‚
â”‚  - GitHub README                                         â”‚
â”‚  - Personal Website                                      â”‚
â”‚  - Blog                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ HTTP GET /api/graph?user=xxx
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Express Server (Port 3000)                  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Routes                                          â”‚   â”‚
â”‚  â”‚  - GET /                (Demo Page)              â”‚   â”‚
â”‚  â”‚  - GET /api/graph       (Animated WebP)          â”‚   â”‚
â”‚  â”‚  - GET /api/frame       (Single Frame)           â”‚   â”‚
â”‚  â”‚  - GET /health          (Health Check)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                                           â”‚
â”‚              â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Middleware                                      â”‚   â”‚
â”‚  â”‚  - CORS                                          â”‚   â”‚
â”‚  â”‚  - Rate Limiter (TODO)                           â”‚   â”‚
â”‚  â”‚  - Error Handler                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Service Layer                           â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  GitHub      â”‚  â”‚  Hatena      â”‚  â”‚  Cache       â”‚  â”‚
â”‚  â”‚  Client      â”‚  â”‚  Client      â”‚  â”‚  Manager     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                 â”‚                 â”‚           â”‚
â”‚         â–¼                 â–¼                 â–¼           â”‚
â”‚  [ GitHub API ]    [ Hatena RSS ]   [ node-cache ]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚              â”‚              â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Data Processing Layer                   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DataProcessor                                    â”‚   â”‚
â”‚  â”‚  - generateRandomList()     â†’ Step 1             â”‚   â”‚
â”‚  â”‚  - generateCalendarView()   â†’ Step 2             â”‚   â”‚
â”‚  â”‚  - generateWeeklyView()     â†’ Step 3             â”‚   â”‚
â”‚  â”‚  - generate3DView()         â†’ Step 4             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Rendering Layer                         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Browser Instance Pool (Singleton)                â”‚   â”‚
â”‚  â”‚  - Chromium (via Puppeteer)                       â”‚   â”‚
â”‚  â”‚  - Shared across requests                         â”‚   â”‚
â”‚  â”‚  - Auto-cleanup on exit                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                                           â”‚
â”‚              â”œâ”€> Page 1 (Step 1) â”€â”                     â”‚
â”‚              â”œâ”€> Page 2 (Step 2)  â”œâ”€ Promise.all()      â”‚
â”‚              â”œâ”€> Page 3 (Step 3)  â”‚   (Parallel)        â”‚
â”‚              â””â”€> Page 4 (Step 4) â”€â”˜                     â”‚
â”‚                     â”‚                                    â”‚
â”‚                     â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  graph.html (Three.js Template)                   â”‚   â”‚
â”‚  â”‚  - Cached in memory                               â”‚   â”‚
â”‚  â”‚  - Data injection via window.ACTIVITY_DATA        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼ Screenshot (PNG)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Image Processing Layer                  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Sharp                                            â”‚   â”‚
â”‚  â”‚  - PNG â†’ WebP conversion                          â”‚   â”‚
â”‚  â”‚  - Quality: 80-90                                 â”‚   â”‚
â”‚  â”‚  - Effort: 4 (balanced)                           â”‚   â”‚
â”‚  â”‚  - Parallel conversion (4 frames)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼ WebP Buffer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Response                                â”‚
â”‚  - Content-Type: image/webp                              â”‚
â”‚  - Cache-Control: public, max-age=3600                   â”‚
â”‚  - Binary data                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
kira-activity/
â”‚
â”œâ”€â”€ .claude/                      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ CLAUDE.md                 # Claude Codeå‘ã‘ã‚¬ã‚¤ãƒ‰
â”‚   â”œâ”€â”€ DESIGN.md                 # è¨­è¨ˆæ€æƒ³
â”‚   â”œâ”€â”€ TODO.md                   # ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
â”‚   â””â”€â”€ ARCHITECTURE.md           # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
â”‚
â”œâ”€â”€ src/                          # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ server.js                 # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â””â”€ Express setup
â”‚   â”‚   â””â”€ Route definitions
â”‚   â”‚   â””â”€ Middleware
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                 # å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº
â”‚   â”‚   â”œâ”€â”€ github.js             # GitHub API
â”‚   â”‚   â”‚   â””â”€ GitHubClient class
â”‚   â”‚   â”‚   â””â”€ getUserEvents()
â”‚   â”‚   â”‚   â””â”€ getUserActivity()
â”‚   â”‚   â”‚   â””â”€ getComprehensiveActivity()
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ hatena.js             # ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
â”‚   â”‚   â”‚   â””â”€ HatenaBookmarkClient class
â”‚   â”‚   â”‚   â””â”€ getUserBookmarks()
â”‚   â”‚   â”‚   â””â”€ getComprehensiveActivity()
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ cache.js              # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
â”‚   â”‚       â””â”€ CacheManager class
â”‚   â”‚       â””â”€ get() / set() / del() / flush()
â”‚   â”‚
â”‚   â”œâ”€â”€ renderer/                 # ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢é€£
â”‚   â”‚   â”œâ”€â”€ graph.html            # Three.js ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”‚   â”‚   â””â”€ renderStep1() - ãƒ©ãƒ³ãƒ€ãƒ ãƒªã‚¹ãƒˆ
â”‚   â”‚   â”‚   â””â”€ renderStep2() - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼
â”‚   â”‚   â”‚   â””â”€ renderStep3() - é€±æ¬¡æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•
â”‚   â”‚   â”‚   â””â”€ renderStep4() - 3Då¯è¦–åŒ–
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ webp-generator.js    # WebPç”Ÿæˆ
â”‚   â”‚       â””â”€ generateAnimatedWebP()
â”‚   â”‚       â””â”€ generateFrame()
â”‚   â”‚       â””â”€ renderStep() - Puppeteer
â”‚   â”‚       â””â”€ getBrowser() - Singleton
â”‚   â”‚       â””â”€ createAnimatedWebP()
â”‚   â”‚
â”‚   â””â”€â”€ utils/                    # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â””â”€â”€ data-processor.js     # ãƒ‡ãƒ¼ã‚¿å¤‰æ›
â”‚           â””â”€ DataProcessor class
â”‚           â””â”€ process()
â”‚           â””â”€ generateRandomList()
â”‚           â””â”€ generateCalendarView()
â”‚           â””â”€ generateWeeklyView()
â”‚           â””â”€ generate3DView()
â”‚
â”œâ”€â”€ package.json                  # ä¾å­˜é–¢ä¿‚
â”œâ”€â”€ .env.example                  # ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”œâ”€â”€ .gitignore                    # Gité™¤å¤–è¨­å®š
â”œâ”€â”€ README.md                     # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆREADME
â””â”€â”€ PERFORMANCE.md                # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¬ã‚¤ãƒ‰
```

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°

### 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡

```javascript
// src/server.js
app.get('/api/graph', async (req, res) => {
  const { user, source = 'github', style = 'deathnote', size = 'medium' } = req.query;

  // å…¥åŠ›æ¤œè¨¼
  if (!user) {
    return res.status(400).json({ error: 'User parameter is required' });
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
  const cacheKey = `graph_${source}_${user}_${style}_${size}`;
  const cached = cache.get(cacheKey);
  if (cached) {
    return res.send(cached); // å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  }

  // ç”Ÿæˆå‡¦ç†
  const webpBuffer = await generateAnimatedWebP(user, source, style, size);

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
  cache.set(cacheKey, webpBuffer);

  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  res.set('Content-Type', 'image/webp');
  res.send(webpBuffer);
});
```

### 2. ãƒ‡ãƒ¼ã‚¿å–å¾—

```javascript
// src/services/github.js
export class GitHubClient {
  async getComprehensiveActivity(username) {
    // ä¸¦åˆ—å®Ÿè¡Œ
    const [events, commits] = await Promise.all([
      this.getUserEvents(username, 3),     // æœ€æ–°300ã‚¤ãƒ™ãƒ³ãƒˆ
      this.getUserActivity(username)       // æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ
    ]);

    // çµ±åˆ
    const allActivity = [...events, ...commits];

    return {
      username,
      totalActivity: allActivity.length,
      events: allActivity.sort((a, b) => new Date(b.date) - new Date(a.date)),
      fetchedAt: new Date().toISOString()
    };
  }
}
```

### 3. ãƒ‡ãƒ¼ã‚¿å¤‰æ›

```javascript
// src/utils/data-processor.js
export class DataProcessor {
  static process(activityData) {
    const events = activityData.events || [];

    return {
      step1: this.generateRandomList(events),       // 50ä»¶ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º
      step2: this.generateCalendarView(events),     // æ—¥Ã—æ™‚é–“ + é€±æ¬¡ã‚°ãƒ«ãƒ¼ãƒ—
      step3: this.generateWeeklyView(events),       // æ›œæ—¥åˆ¥é›†è¨ˆï¼ˆ7è¦ç´ ï¼‰
      step4: this.generate3DView(events),           // æ›œæ—¥Ã—æ™‚é–“ã‚°ãƒªãƒƒãƒ‰ï¼ˆ168è¦ç´ ï¼‰
      metadata: {
        username: activityData.username,
        totalEvents: events.length,
        dateRange: this.getDateRange(events)
      }
    };
  }
}
```

#### Step 2ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆé‡è¦ï¼‰

```javascript
{
  full: {
    '2024-01-15': [0, 0, 3, 5, 2, ...],  // 24æ™‚é–“åˆ†
    '2024-01-16': [1, 0, 0, 4, 3, ...],
    // ...
  },
  weeks: [
    [  // Week 1
      { date: '2024-01-15', dayOfWeek: 1, hours: [...] },
      { date: '2024-01-16', dayOfWeek: 2, hours: [...] },
      // ...
    ],
    [  // Week 2
      { date: '2024-01-22', dayOfWeek: 1, hours: [...] },
      // ...
    ]
  ]
}
```

### 4. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰

```javascript
// src/renderer/webp-generator.js
export async function generateAnimatedWebP(username, source, style, size) {
  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  const activityData = await fetchActivityData(username, source);
  const processedData = DataProcessor.process(activityData);

  // ä¸¦åˆ—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆé‡è¦ï¼ï¼‰
  const framePromises = [1, 2, 3, 4].map(step =>
    renderStep(processedData, step, style, size)
  );

  const frames = await Promise.all(framePromises);
  // â†‘ 4ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’åŒæ™‚ç”Ÿæˆï¼ˆ4å€é«˜é€Ÿï¼‰

  // WebPå¤‰æ›
  const webpBuffer = await createAnimatedWebP(frames, delays);

  return webpBuffer;
}
```

#### ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç®¡ç†ï¼ˆSingletonï¼‰

```javascript
let browserInstance = null;

async function getBrowser() {
  if (!browserInstance || !browserInstance.isConnected()) {
    browserInstance = await puppeteer.launch({
      headless: 'new',
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--disable-web-security',
        '--disable-features=IsolateOrigins,site-per-process'
      ]
    });

    // ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†æ™‚ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    process.on('exit', async () => {
      if (browserInstance) {
        await browserInstance.close();
      }
    });
  }

  return browserInstance;
}
```

#### ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

```javascript
async function renderStep(processedData, step, style, size) {
  const browser = await getBrowser();  // ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³å–å¾—
  const page = await browser.newPage(); // æ–°ã—ã„ãƒšãƒ¼ã‚¸ä½œæˆ

  try {
    // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆè¨­å®š
    await page.setViewport(getSizeDimensions(size));

    // HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
    const htmlContent = getHTMLTemplate();

    // ãƒ‡ãƒ¼ã‚¿æ³¨å…¥
    const injectedHTML = htmlContent.replace(
      '</head>',
      `<script>
        window.ACTIVITY_DATA = ${JSON.stringify(processedData)};
        window.RENDER_STEP = ${step};
        window.RENDER_STYLE = '${style}';
      </script></head>`
    );

    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    await page.setContent(injectedHTML, { waitUntil: 'networkidle0' });

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…æ©Ÿ
    await new Promise(resolve => setTimeout(resolve, waitTime));

    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
    const screenshot = await page.screenshot({
      type: 'png',
      fullPage: false,
      captureBeyondViewport: false
    });

    return screenshot;
  } finally {
    await page.close();  // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã¯ç¶­æŒï¼‰
  }
}
```

### 5. ç”»åƒå¤‰æ›ï¼ˆä¸¦åˆ—ï¼‰

```javascript
async function createAnimatedWebP(frames, delays) {
  // ä¸¦åˆ—WebPå¤‰æ›
  const webpFrames = await Promise.all(
    frames.map(frame =>
      sharp(frame)
        .webp({ quality: 80, effort: 4 })
        .toBuffer()
    )
  );

  // ç¾åœ¨: Step 4ã®ã¿è¿”ã™
  // TODO: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³WebPç”Ÿæˆ
  return webpFrames[webpFrames.length - 1];
}
```

## ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®è¨­è¨ˆ

```
graph_{source}_{user}_{style}_{size}
frame_{source}_{user}_{step}_{style}

ä¾‹:
- graph_github_torvalds_deathnote_medium
- frame_hatena_alice_2_deathnote
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼

```
Request
  â”‚
  â”œâ”€> Check Cache
  â”‚   â”œâ”€> Hit  â†’ Return immediately (< 10ms)
  â”‚   â””â”€> Miss â†’ Continue
  â”‚
  â”œâ”€> Generate WebP (4-6 seconds)
  â”‚
  â”œâ”€> Store in Cache (TTL: 3600s)
  â”‚
  â””â”€> Return WebP
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆ

```javascript
// src/services/cache.js
getStats() {
  return {
    keys: this.cache.keys().length,
    hits: this.hits,
    misses: this.misses,
    hitRate: this.hits / (this.hits + this.misses)
  };
}
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ

```
Total Time: ~6 seconds (Node.js)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase                               â”‚ Time     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Data Fetching (GitHub API)       â”‚ 800ms    â”‚
â”‚ 2. Data Processing                  â”‚ 50ms     â”‚
â”‚ 3. Browser Rendering (4 frames)     â”‚ 4500ms   â”‚ â† ãƒœãƒˆãƒ«ãƒãƒƒã‚¯
â”‚    - Step 1                         â”‚ 2500ms   â”‚
â”‚    - Step 2                         â”‚ 4000ms   â”‚
â”‚    - Step 3                         â”‚ 1500ms   â”‚
â”‚    - Step 4                         â”‚ 4000ms   â”‚
â”‚    (ä¸¦åˆ—å®Ÿè¡Œã«ã‚ˆã‚Šæœ€å¤§å€¤ã®ã¿)        â”‚ = 4500ms â”‚
â”‚ 4. WebP Conversion (4 frames)       â”‚ 600ms    â”‚
â”‚ 5. Response                         â”‚ 50ms     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Total                               â”‚ 6000ms   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœ€é©åŒ–ã®åŠ¹æœ

```
æœ€é©åŒ–å‰ï¼ˆé€æ¬¡å®Ÿè¡Œ + ãƒ–ãƒ©ã‚¦ã‚¶æ¯å›èµ·å‹•ï¼‰:
  ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•Ã—4: 10ç§’
  ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°Ã—4: 16ç§’ (4ç§’Ã—4)
  åˆè¨ˆ: 26ç§’

æœ€é©åŒ–å¾Œï¼ˆä¸¦åˆ—å®Ÿè¡Œ + ãƒ–ãƒ©ã‚¦ã‚¶å†åˆ©ç”¨ï¼‰:
  ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•Ã—1: 0ç§’ï¼ˆåˆå›ã®ã¿2.5ç§’ï¼‰
  ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°Ã—4: 4.5ç§’ï¼ˆä¸¦åˆ—ï¼‰
  åˆè¨ˆ: 6ç§’ï¼ˆåˆå›8.5ç§’ï¼‰

æ”¹å–„ç‡: 4.3å€é«˜é€ŸåŒ–
```

## ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load Balancer    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
    â”‚     â”‚     â”‚
    â–¼     â–¼     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Serverâ”‚â”‚Serverâ”‚â”‚Serverâ”‚
â”‚  1   â”‚â”‚  2   â”‚â”‚  3   â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚       â”‚       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Redis Cache   â”‚
   â”‚ (Shared)      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒªã‚½ãƒ¼ã‚¹è¦ä»¶

| åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | CPU | Memory | æ¨å¥¨ã‚µãƒ¼ãƒãƒ¼æ•° |
|--------------|-----|--------|---------------|
| 1-5          | 2ã‚³ã‚¢ | 2GB    | 1             |
| 5-20         | 4ã‚³ã‚¢ | 4GB    | 1-2           |
| 20-50        | 8ã‚³ã‚¢ | 8GB    | 2-3           |
| 50+          | -    | -      | 3+ + Redis    |

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### æ”»æ’ƒãƒ™ã‚¯ãƒˆãƒ«ã¨å¯¾ç­–

| æ”»æ’ƒã‚¿ã‚¤ãƒ— | å¯¾ç­– | å®Ÿè£…çŠ¶æ³ |
|-----------|------|---------|
| DoS       | Rate Limiting | TODO |
| XSS       | N/A (ç”»åƒã®ã¿) | - |
| SQLi      | N/A (DBæœªä½¿ç”¨) | - |
| SSRF      | å…¥åŠ›æ¤œè¨¼ | âœ… |
| ãƒˆãƒ¼ã‚¯ãƒ³æ¼æ´© | .env + .gitignore | âœ… |

### å…¥åŠ›æ¤œè¨¼

```javascript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
const sanitizeUsername = (username) => {
  return username.replace(/[^a-zA-Z0-9-_]/g, '');
};

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
const validateParams = (req) => {
  const { user, source, step, style, size } = req.query;

  if (!user || user.length > 39) {
    throw new APIError('Invalid username', 400);
  }

  if (source && !['github', 'hatena'].includes(source)) {
    throw new APIError('Invalid source', 400);
  }

  if (step && (step < 1 || step > 4)) {
    throw new APIError('Invalid step', 400);
  }

  return true;
};
```

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ãƒ­ã‚°è¨­è¨ˆ

```javascript
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°
console.log(`ğŸ“¥ [${new Date().toISOString()}] ${method} ${url} - User: ${user}`);

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ­ã‚°
console.log(`â±ï¸  Rendered in ${duration}ms`);

// ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
console.error(`âŒ [${new Date().toISOString()}] ${error.message}`, error.stack);

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ­ã‚°
console.log(`âœ… Cache hit: ${key}`);
console.log(`âŒ Cache miss: ${key}`);
```

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹

è¿½è·¡ã™ã¹ãæŒ‡æ¨™ï¼š
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°/åˆ†
- å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
- ã‚¨ãƒ©ãƒ¼ç‡
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°

## ãƒ‡ãƒ—ãƒ­ã‚¤

### ç’°å¢ƒåˆ¥è¨­å®š

```javascript
// .env.development
PORT=3000
GITHUB_TOKEN=ghp_dev_xxx
CACHE_TTL=60
NODE_ENV=development

// .env.production
PORT=8080
GITHUB_TOKEN=ghp_prod_xxx
CACHE_TTL=3600
NODE_ENV=production
```

### ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³

| Platform | Pros | Cons |
|----------|------|------|
| Vercel | ç°¡å˜ã€ç„¡æ–™æ  | Puppeteeråˆ¶é™ã‚ã‚Š |
| Railway | Dockerã‚µãƒãƒ¼ãƒˆ | æœ‰æ–™ã®ã¿ |
| Fly.io | é«˜é€Ÿã€ã‚°ãƒ­ãƒ¼ãƒãƒ« | è¨­å®šã‚„ã‚„è¤‡é›‘ |
| Heroku | ã‚·ãƒ³ãƒ—ãƒ« | é«˜ã‚³ã‚¹ãƒˆ |
| VPS (è‡ªå‰) | å®Œå…¨åˆ¶å¾¡ | é‹ç”¨è² æ‹… |

## ä¾å­˜é–¢ä¿‚

### Production

```json
{
  "express": "^4.18.2",       // Webã‚µãƒ¼ãƒãƒ¼
  "puppeteer": "^21.6.1",     // ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶
  "sharp": "^0.33.1",         // ç”»åƒå‡¦ç†
  "node-cache": "^5.1.2",     // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  "dotenv": "^16.3.1",        // ç’°å¢ƒå¤‰æ•°
  "axios": "^1.6.2",          // HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
  "xml2js": "^0.6.2"          // XML ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã¯ã¦ãªç”¨ï¼‰
}
```

### Development

```json
{
  "nodemon": "^3.0.2"         // ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰
}
```

## ä»Šå¾Œã®æ‹¡å¼µæ€§

### Phase 2: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ

```
ç¾åœ¨: Step 4ã®é™æ­¢ç”»
  â†“
Phase 2: çœŸã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³WebP
  Step 1 â†’ Step 2 â†’ Step 3 â†’ Step 4
  (å„1.5ç§’ + æœ€å¾Œ3ç§’ = 7.5ç§’ãƒ«ãƒ¼ãƒ—)
```

### Phase 3: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

```
WebSocketçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  â†“
æ–°ã—ã„æ´»å‹•ãŒã‚ã‚‹ã¨è‡ªå‹•å†ç”Ÿæˆ
  â†“
ãƒ–ãƒ©ã‚¦ã‚¶ã«é€šçŸ¥
```

### Phase 4: åˆ†æ•£å‡¦ç†

```
ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ¼ãƒ«
  â†“
å„ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
  â†“
ã‚¹ã‚±ãƒ¼ãƒ«: 1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’ â†’ 100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’
```

---

æœ€çµ‚æ›´æ–°: 2025-11-17
